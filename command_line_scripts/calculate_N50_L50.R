#!/usr/bin/env Rscript
# assembly_stats.R
# This script calculates genome assembly statistics (N50 and L50)
# from a FASTA index file (.fai) generated by tools like samtools faidx.
#
# Usage:
#   Rscript assembly_stats.R <input_fasta.fai> <output_file.txt>
#
# The script uses positional arguments (via commandArgs(trailingOnly = TRUE))
# to specify the input and output files.
#
# N50 is defined as the length of the contig at which the cumulative length
# of the contigs (sorted from longest to shortest) reaches 50% of the total assembly.
# L50 is the minimal number of contigs required to reach that 50% threshold.

# Parse command-line arguments
args <- commandArgs(trailingOnly = TRUE)
if (length(args) < 2) {
  stop("Usage: Rscript assembly_stats.R <input_fasta.fai> <output_file.txt>")
}

input_file <- args[1]
output_file <- args[2]

# Read the FASTA index file (tab-delimited; no header expected)
fai <- read.table(input_file, header = FALSE, sep = "\t", stringsAsFactors = FALSE)
if (ncol(fai) < 2) {
  stop("Input file does not have at least two columns.")
}

# Extract contig lengths (assumed to be in the second column)
contig_lengths <- as.numeric(fai[[2]])

# Calculate the total genome length
total_length <- sum(contig_lengths, na.rm = TRUE)

# Sort the contig lengths in descending order
sorted_lengths <- sort(contig_lengths, decreasing = TRUE)

# Compute the cumulative sum of sorted lengths
cumsum_lengths <- cumsum(sorted_lengths)

# Identify the index where the cumulative sum reaches at least 50% of total length
L50_index <- which(cumsum_lengths >= total_length / 2)[1]

# The N50 value is the length at this index
N50 <- sorted_lengths[L50_index]
L50 <- L50_index

# Create output text with assembly statistics
output_table <- data.frame(
  Statistic = c("Total Length", "N50", "L50"),
  Value = c(total_length, N50, L50)
)

write.table(output_table, file = output_file, sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)

